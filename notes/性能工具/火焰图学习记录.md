# 火焰图

术语FlameGraphs和FlameCharts通常可以互换使用，但有所不同。

FlameCharts用于按时间顺序表示单个配置文件的堆栈样本，而FlameGraphs则表示分析程序的堆栈总体。它们优化了合并堆栈以显示聚合函数持续时间。<br>
以这种方式聚合堆栈可以帮助开发者通过可视化最常占用程序调用堆栈的代码来找到性能优化。

## FlameGraphs

火焰图是分层数据的可视化，创建它是为了可视化分析软件的堆栈跟踪，以便快速准确地识别最频繁的代码路径。

火焰图可视化了函数调用关系和其在整个程序执行期间的耗时。技术专家通过分析火焰图中不同函数之间的调用关系和函数自身的耗时，可以了解应用程序在不同代码路径上的性能瓶颈，并进行性能优化。

火焰图(FlameGraphs)具有以下特点：
- 火焰图的栈跟踪被表示为一列方框，每个方框代表一个函数（一个栈帧）。
- 火焰图的纵轴显示栈的深度，从根部位于底部到叶部位于顶部的顺序排列。顶部方框显示在收集栈跟踪时处于CPU上的函数，其下方是它的祖先函数。一个函数下面的函数是它的父函数。
- 火焰图的横轴跨越栈跟踪的收集。它不体现时间的流逝，所以从左到右的顺序没有特殊意义。栈跟踪的从左到右的顺序按照函数名称的字母顺序，从每个栈的根部到叶部排列。这样可以最大程度地合并方框：当水平相邻的函数方框相同时，它们会被合并。
- 火焰图中每个函数方框的宽度显示了该函数在栈跟踪中出现的频率，或者作为栈跟踪祖先的一部分。具有较宽方框的函数在栈跟踪中出现的频率比具有较窄方框的函数高，与它们的宽度成比例。虽然如此，更宽的宽度未必意味着更频繁的CPU调用，也可能是单次函数调用消耗更多的CPU资源。
    - 如果火焰图中每个函数方框足够宽，它会显示完整的函数名称；如果不够宽，会显示截断的函数名称带有省略号，或者不显示任何内容。
    - 火焰图可以体现函数总的运行时间和函数自身的运行时间。总的运行时间是指函数及其所有子函数执行所花费的时间；自身的运行时间是指函数本身执行所花费的时间，不包括在子函数中花费的时间。
- 火焰图中每个函数方框的背景颜色并不重要，是随机选择的温暖色调。这种随机性有助于眼睛区分方框，特别是对于相邻的细长的"塔"。
- 火焰图可视化的分析范围可以跨越单个线程、多个线程、多个应用程序或多个主机。如果需要，可以生成单独的火焰图，特别是用于研究单个线程。
- 栈跟踪可以从不同的分析器目标收集，方框的宽度可以反映除采样计数以外的其他度量指标。例如，分析器（或追踪器）可以测量线程的阻塞时间以及其栈跟踪。这些数据可以可视化为火焰图，其中横轴跨越总的阻塞时间，火焰图显示阻塞代码路径。
- 当火焰图中同一个函数顶部出现多个分叉，意味着该函数出现了不同的逻辑分组，这些分组将分阶段工作。

火焰图既是一种静态的可视化工具，也是一种动态的可视化工具。
- 作为一种静态可视化工具，火焰图可以保存为图像，包含在印刷品中，仍然能传达"全局视图"，因为只有最常见的帧才有足够宽度来显示标签。整个分析器的输出被一次性可视化，最终用户可以直观地导航到感兴趣的区域，火焰图中的形状和位置成为观测软件执行的可视化地图。
- 作为一种动态可视化工具，火焰图允许交互式功能来帮助导航和理解，包括：
    - 鼠标悬停显示状态栏中的额外帧详细信息（完整的函数名称、配置文件中存在的样本数以及配置文件中这些样本的相应百分比）。
    - 鼠标单击水平缩放可视化工具，显示之前省略的函数名称。
    - 搜索匹配并突出显示给定术语，并显示包含搜索术语的栈的"累积百分比"。

一些操作系统分析工具内置了对火焰图的支持：
- Linux：perf
- Windows：WPA、PerfView

火焰图也可以从任何包含堆栈跟踪的分析数据生成，包括来自以下分析工具：
- Linux：perf、eBPF、SystemTap、ktap
- FreeBSD：DTrace
- MacOSX：Instruments
- Windows：Xperf.exe

当perf生成火焰图时，它会尝试解析二进制文件中的符号信息，以便将程序的地址映射到函数名或符号名称。

## FlameCharts

火焰图(FlameCharts)具有以下特点：
- 火焰图按时间顺序显示单个配置文件持续时间内的堆栈样本。
- 火焰图中的每个矩形代表一个堆栈帧。
- 火焰图的X轴表示时间，Y轴表示当时的执行堆栈，可以查看程序在任何给定时刻正在执行的内容。
- 火焰图中每个堆栈帧矩形的宽度表示该函数所花费的时间。
- 火焰图可以查看函数总运行时间和函数自身运行时间。函数总运行时间是指执行一个函数及其所有子函数所花费的时间；函数自身运行时间是指函数本身执行所花费的时间，不包括子函数执行所花费的时间。

# 安装配置FlameGraph

下载[FlameGraph](https://github.com/brendangregg/FlameGraph)源码：
```shell
git clone https://github.com/brendangregg/FlameGraph.git
```

配置FlameGraph环境变量：
```shell
vim /etc/profile
```

向`/etc/profile`文件中添加下面的内容：
```shell
export FLAMEGRAPH_DIR=/home/<username>/FlameGraph
```

修改后立即生效：
```shell
source /etc/profile
```

将perf数据转化为txt格式：
```shell
perf script > perf.data.txt
```

根据`perf.data.txt`生成火焰图：
```shell
./FlameGraph/stackcollapse-perf.pl perf.data.txt | ./FlameGraph/flamegraph.pl > flamegraph.svg
```
